service: selfpomodoro-serverless

provider:
  name: aws
  runtime: provided.al2
  region: ap-northeast-1
  stage: ${opt:stage, 'dev'}
  profile: selfpomodoro-dev
  versionFunctions: false

  environment:
    DB_HOST: ${env:DB_HOST}
    DB_PORT: ${env:DB_PORT}
    DB_USER: ${env:DB_USER}
    DB_PASSWORD: ${env:DB_PASSWORD}
    DB_NAME: ${env:DB_NAME}
    DB_SSL_MODE: ${env:DB_SSL_MODE}
    COGNITO_USER_POOL_ID: ${env:COGNITO_USER_POOL_ID}
    COGNITO_CLIENT_ID: ${env:COGNITO_CLIENT_ID}
    DYNAMO_USER_CONFIG_TABLE: ${env:DYNAMO_USER_CONFIG_TABLE}
    DYNAMO_ROUND_OPTIMIZATION_TABLE: ${env:DYNAMO_ROUND_OPTIMIZATION_TABLE}
    DYNAMO_SESSION_OPTIMIZATION_TABLE: ${env:DYNAMO_SESSION_OPTIMIZATION_TABLE}
    SQS_ROUND_OPTIMIZATION_URL: ${env:SQS_ROUND_OPTIMIZATION_URL}
    SQS_SESSION_OPTIMIZATION_URL: ${env:SQS_SESSION_OPTIMIZATION_URL}
    LOG_LEVEL: ${env:LOG_LEVEL}
    ENVIRONMENT: ${env:ENVIRONMENT}

functions:
  api-tasks:
    handler: bootstrap
    package:
      artifact: functions/api-tasks/bootstrap.zip
    events:
      # ã‚¿ã‚¹ã‚¯ä¸€è¦§å–å¾—
      - http:
          path: /api/v1/tasks
          method: get
          cors: true
      # ã‚¿ã‚¹ã‚¯ä½œæˆ
      - http:
          path: /api/v1/tasks
          method: post
          cors: true
      # ã‚¿ã‚¹ã‚¯æ›´æ–°
      - http:
          path: /api/v1/tasks/{task_id}/edit
          method: patch
          cors: true
      # ã‚¿ã‚¹ã‚¯å®Œäº†çŠ¶æ…‹åˆ‡ã‚Šæ›¿ãˆ
      - http:
          path: /api/v1/tasks/{task_id}/toggle
          method: patch
          cors: true
      # ã‚¿ã‚¹ã‚¯å‰Šé™¤
      - http:
          path: /api/v1/tasks/{task_id}
          method: delete
          cors: true

  api-sessions:
    handler: bootstrap
    package:
      artifact: functions/api-sessions/bootstrap.zip
    events:
      # ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§å–å¾—
      - http:
          path: /api/v1/sessions
          method: get
          cors: true
      # ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
      - http:
          path: /api/v1/sessions
          method: post
          cors: true
      # ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—
      - http:
          path: /api/v1/sessions/{session_id}
          method: get
          cors: true
      # ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†
      - http:
          path: /api/v1/sessions/{session_id}/complete
          method: patch
          cors: true
      # ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤
      - http:
          path: /api/v1/sessions/{session_id}
          method: delete
          cors: true

  api-rounds:
    handler: bootstrap
    package:
      artifact: functions/api-rounds/bootstrap.zip
    events:
      # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ©ã‚¦ãƒ³ãƒ‰ä¸€è¦§å–å¾—
      - http:
          path: /api/v1/sessions/{session_id}/rounds
          method: get
          cors: true
      # ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹
      - http:
          path: /api/v1/sessions/{session_id}/rounds
          method: post
          cors: true
      # ãƒ©ã‚¦ãƒ³ãƒ‰å–å¾—
      - http:
          path: /api/v1/rounds/{round_id}
          method: get
          cors: true
      # ãƒ©ã‚¦ãƒ³ãƒ‰å®Œäº†
      - http:
          path: /api/v1/rounds/{round_id}/complete
          method: patch
          cors: true
      # ãƒ©ã‚¦ãƒ³ãƒ‰ä¸­æ­¢
      - http:
          path: /api/v1/rounds/{round_id}/abort
          method: post
          cors: true

  api-statistics:
    handler: bootstrap
    package:
      artifact: functions/api-statistics/bootstrap.zip
    events:
      # é›†ä¸­åº¦ãƒˆãƒ¬ãƒ³ãƒ‰å–å¾—
      - http:
          path: /api/v1/statistics/focus-trend
          method: get
          cors: true
      # é›†ä¸­åº¦ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—å–å¾—
      - http:
          path: /api/v1/statistics/focus-heatmap
          method: get
          cors: true

  # ğŸ¯ PostConfirmation Trigger Lambdaé–¢æ•°ï¼ˆæ–°è¦è¿½åŠ ï¼‰
  post-confirmation:
    handler: bootstrap
    package:
      artifact: functions/cognito-triggers/post-confirmation/bootstrap.zip
    timeout: 30
    memorySize: 256
    # Cognito Triggerã®å ´åˆã€eventsã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ä¸è¦ï¼ˆresourcesã§è¨­å®šï¼‰

package:
  individually: true

# ğŸ¯ AWS Resourceså®šç¾©ï¼ˆCognito + PostConfirmationçµ±åˆï¼‰
resources:
  Resources:
    # Cognito User Poolï¼ˆæ—¢å­˜ã®ã‚‚ã®ã‚’å‚ç…§ãƒ»æ›´æ–°ï¼‰
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: selfpomodoro-users-${self:provider.stage}
        # PostConfirmation Triggerè¨­å®š
        LambdaConfig:
          PostConfirmation: !GetAtt PostDashconfirmationLambdaFunction.Arn
        # åŸºæœ¬è¨­å®š
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireUppercase: false
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: false
        Schema:
          - Name: email
            AttributeDataType: String
            Required: true
            Mutable: true
          - Name: name
            AttributeDataType: String
            Required: false
            Mutable: true
          - Name: given_name
            AttributeDataType: String
            Required: false
            Mutable: true
          - Name: family_name
            AttributeDataType: String
            Required: false
            Mutable: true
        AutoVerifiedAttributes:
          - email
        UsernameAttributes:
          - email
        
    # Cognito User Pool Clientï¼ˆæ—¢å­˜ã®ã‚‚ã®ã‚’å‚ç…§ãƒ»æ›´æ–°ï¼‰
    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: selfpomodoro-client-${self:provider.stage}
        UserPoolId: !Ref CognitoUserPool
        ExplicitAuthFlows:
          - ADMIN_NO_SRP_AUTH
          - USER_PASSWORD_AUTH
        GenerateSecret: false
        TokenValidityUnits:
          AccessToken: hours
          IdToken: hours
          RefreshToken: days
        AccessTokenValidity: 24
        IdTokenValidity: 24
        RefreshTokenValidity: 30

    # PostConfirmation Lambdaå®Ÿè¡Œæ¨©é™
    PostConfirmationLambdaPermission:
      Type: AWS::Lambda::Permission
      Properties:
        Action: lambda:invokeFunction
        FunctionName: !GetAtt PostDashconfirmationLambdaFunction.Arn
        Principal: cognito-idp.amazonaws.com
        SourceArn: !GetAtt CognitoUserPool.Arn

  # CloudFormation Outputsï¼ˆç’°å¢ƒå¤‰æ•°ã‚„APIç¢ºèªç”¨ï¼‰
  Outputs:
    CognitoUserPoolId:
      Description: "Cognito User Pool ID"
      Value: !Ref CognitoUserPool
      
    CognitoUserPoolClientId:
      Description: "Cognito User Pool Client ID"
      Value: !Ref CognitoUserPoolClient
      
    PostConfirmationFunctionArn:
      Description: "PostConfirmation Lambda Function ARN"
      Value: !GetAtt PostDashconfirmationLambdaFunction.Arn

# Selfpomodoro Serverless Makefile

# å¤‰æ•°å®šç¾©
GOOS := linux
GOARCH := amd64
CGO_ENABLED := 0

# Lambdaé–¢æ•°ä¸€è¦§
FUNCTIONS := api-tasks api-sessions api-rounds api-statistics

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
.PHONY: help
help:
	@echo "ä½¿ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@echo "  make build-all      - å…¨Lambdaé–¢æ•°ã‚’ãƒ“ãƒ«ãƒ‰"
	@echo "  make deploy-all     - å…¨Lambdaé–¢æ•°ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤"
	@echo "  make test-all       - å…¨APIã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
	@echo "  make clean          - ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤"
	@echo ""
	@echo "å€‹åˆ¥é–¢æ•°æ“ä½œ:"
	@echo "  make build-<function>   - æŒ‡å®šé–¢æ•°ã‚’ãƒ“ãƒ«ãƒ‰"
	@echo "  make deploy-<function>  - æŒ‡å®šé–¢æ•°ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤"
	@echo ""
	@echo "ãã®ä»–:"
	@echo "  make migrate-up     - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨"
	@echo "  make migrate-down   - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯"
	@echo "  make logs-<function> - æŒ‡å®šé–¢æ•°ã®ãƒ­ã‚°ã‚’è¡¨ç¤º"

# å…¨Lambdaé–¢æ•°ãƒ“ãƒ«ãƒ‰
.PHONY: build-all
build-all: $(foreach func,$(FUNCTIONS),build-$(func))
	@echo "âœ… å…¨Lambdaé–¢æ•°ã®ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ"

# å€‹åˆ¥Lambdaé–¢æ•°ãƒ“ãƒ«ãƒ‰
.PHONY: build-api-tasks
build-api-tasks:
	@echo "ğŸ”¨ api-tasks ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
	@cd functions/api-tasks && \
	GOOS=$(GOOS) GOARCH=$(GOARCH) CGO_ENABLED=$(CGO_ENABLED) \
	go build -ldflags="-s -w" -o bootstrap main.go && \
	zip bootstrap.zip bootstrap && \
	rm bootstrap
	@echo "âœ… api-tasks ãƒ“ãƒ«ãƒ‰å®Œäº†"

.PHONY: build-api-sessions
build-api-sessions:
	@echo "ğŸ”¨ api-sessions ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
	@cd functions/api-sessions && \
	GOOS=$(GOOS) GOARCH=$(GOARCH) CGO_ENABLED=$(CGO_ENABLED) \
	go build -ldflags="-s -w" -o bootstrap main.go && \
	zip bootstrap.zip bootstrap && \
	rm bootstrap
	@echo "âœ… api-sessions ãƒ“ãƒ«ãƒ‰å®Œäº†"

.PHONY: build-api-rounds
build-api-rounds:
	@echo "ğŸ”¨ api-rounds ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
	@cd functions/api-rounds && \
	GOOS=$(GOOS) GOARCH=$(GOARCH) CGO_ENABLED=$(CGO_ENABLED) \
	go build -ldflags="-s -w" -o bootstrap main.go && \
	zip bootstrap.zip bootstrap && \
	rm bootstrap
	@echo "âœ… api-rounds ãƒ“ãƒ«ãƒ‰å®Œäº†"

.PHONY: build-api-statistics
build-api-statistics:
	@echo "ğŸ”¨ api-statistics ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
	@cd functions/api-statistics && \
	GOOS=$(GOOS) GOARCH=$(GOARCH) CGO_ENABLED=$(CGO_ENABLED) \
	go build -ldflags="-s -w" -o bootstrap main.go && \
	zip bootstrap.zip bootstrap && \
	rm bootstrap
	@echo "âœ… api-statistics ãƒ“ãƒ«ãƒ‰å®Œäº†"

# ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰
.PHONY: deploy-all
deploy-all: build-all
	@echo "ğŸš€ å…¨Lambdaé–¢æ•°ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	serverless deploy --aws-profile selfpomodoro-dev
	@echo "âœ… å…¨Lambdaé–¢æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"

.PHONY: deploy-function
deploy-function:
	@if [ -z "$(FUNC)" ]; then \
		echo "âŒ ã‚¨ãƒ©ãƒ¼: FUNCå¤‰æ•°ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ (ä¾‹: make deploy-function FUNC=api-tasks)"; \
		exit 1; \
	fi
	@echo "ğŸš€ $(FUNC) ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	serverless deploy function --function $(FUNC) --aws-profile selfpomodoro-dev
	@echo "âœ… $(FUNC) ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"

# å€‹åˆ¥é–¢æ•°ãƒ‡ãƒ—ãƒ­ã‚¤
.PHONY: deploy-api-tasks
deploy-api-tasks: build-api-tasks
	@echo "ğŸš€ api-tasks ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	serverless deploy function --function api-tasks --aws-profile selfpomodoro-dev
	@echo "âœ… api-tasks ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

.PHONY: deploy-api-sessions
deploy-api-sessions: build-api-sessions
	@echo "ğŸš€ api-sessions ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	serverless deploy function --function api-sessions --aws-profile selfpomodoro-dev
	@echo "âœ… api-sessions ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

.PHONY: deploy-api-rounds
deploy-api-rounds: build-api-rounds
	@echo "ğŸš€ api-rounds ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	serverless deploy function --function api-rounds --aws-profile selfpomodoro-dev
	@echo "âœ… api-rounds ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

.PHONY: deploy-api-statistics
deploy-api-statistics: build-api-statistics
	@echo "ğŸš€ api-statistics ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	serverless deploy function --function api-statistics --aws-profile selfpomodoro-dev
	@echo "âœ… api-statistics ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
.PHONY: test-all
test-all:
	@echo "ğŸ§ª å…¨APIãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
	@chmod +x test-all-apis.sh
	@./test-all-apis.sh

# ãƒ­ã‚°ç¢ºèª
.PHONY: logs-api-tasks
logs-api-tasks:
	@echo "ğŸ“ api-tasks ã®ãƒ­ã‚°ã‚’è¡¨ç¤º..."
	aws logs tail /aws/lambda/selfpomodoro-serverless-dev-api-tasks --follow --profile selfpomodoro-dev

.PHONY: logs-api-sessions
logs-api-sessions:
	@echo "ğŸ“ api-sessions ã®ãƒ­ã‚°ã‚’è¡¨ç¤º..."
	aws logs tail /aws/lambda/selfpomodoro-serverless-dev-api-sessions --follow --profile selfpomodoro-dev

.PHONY: logs-api-rounds
logs-api-rounds:
	@echo "ğŸ“ api-rounds ã®ãƒ­ã‚°ã‚’è¡¨ç¤º..."
	aws logs tail /aws/lambda/selfpomodoro-serverless-dev-api-rounds --follow --profile selfpomodoro-dev

.PHONY: logs-api-statistics
logs-api-statistics:
	@echo "ğŸ“ api-statistics ã®ãƒ­ã‚°ã‚’è¡¨ç¤º..."
	aws logs tail /aws/lambda/selfpomodoro-serverless-dev-api-statistics --follow --profile selfpomodoro-dev

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ—¢å­˜æ©Ÿèƒ½ç¶­æŒï¼‰
.PHONY: migrate-up
migrate-up:
	@echo "ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ: ./migrations/sql"
	@if [ -f .env ]; then \
		export $$(grep -v '^#' .env | xargs); \
		migrate -path ./migrations/sql -database "postgres://$$DB_USER:$$DB_PASSWORD@$$DB_HOST:$$DB_PORT/$$DB_NAME?sslmode=$$DB_SSL_MODE" up; \
	else \
		echo "âŒ .env ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		exit 1; \
	fi

.PHONY: migrate-down
migrate-down:
	@echo "ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯: ./migrations/sql"
	@if [ -f .env ]; then \
		export $$(grep -v '^#' .env | xargs); \
		migrate -path ./migrations/sql -database "postgres://$$DB_USER:$$DB_PASSWORD@$$DB_HOST:$$DB_PORT/$$DB_NAME?sslmode=$$DB_SSL_MODE" down 1; \
	else \
		echo "âŒ .env ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		exit 1; \
	fi

# æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
.PHONY: migrate-create
migrate-create:
	@read -p "ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„: " name; \
	./scripts/migrate.sh create $$name

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
.PHONY: clean
clean:
	@echo "ğŸ§¹ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤ä¸­..."
	@find . -name "bootstrap.zip" -delete
	@find . -name "bootstrap" -delete
	@echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

# é–‹ç™ºç”¨ã‚³ãƒãƒ³ãƒ‰
.PHONY: dev
dev:
	@echo "ğŸƒ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã®è¿…é€Ÿãƒ‡ãƒ—ãƒ­ã‚¤..."
	@echo "1. å…¨é–¢æ•°ãƒ“ãƒ«ãƒ‰"
	@make build-all
	@echo "2. ãƒ‡ãƒ—ãƒ­ã‚¤"
	@make deploy-all
	@echo "3. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
	@sleep 10  # ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾…æ©Ÿ
	@make test-all

# æƒ…å ±è¡¨ç¤º
.PHONY: info
info:
	@echo "ğŸ“Š ç¾åœ¨ã®è¨­å®šæƒ…å ±:"
	@echo "  ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: selfpomodoro-serverless"
	@echo "  ã‚¹ãƒ†ãƒ¼ã‚¸: dev"
	@echo "  ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: ap-northeast-1"
	@echo "  ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«: selfpomodoro-dev"
	@echo ""
	@echo "ğŸ“ Lambdaé–¢æ•°:"
	@for func in $(FUNCTIONS); do echo "  - $func"; done
	@echo ""
	@echo "ğŸŒ API Gateway:"
	@echo "  Base URL: https://f0vvgsmjj7.execute-api.ap-northeast-1.amazonaws.com/dev"

# ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
.PHONY: error-help
error-help:
	@echo "âŒ ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨è§£æ±ºæ–¹æ³•:"
	@echo ""
	@echo "1. ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼:"
	@echo "   - go.mod ã®ä¾å­˜é–¢ä¿‚ã‚’ç¢ºèª: go mod tidy"
	@echo "   - internal ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ‘ã‚¹ã‚’ç¢ºèª"
	@echo ""
	@echo "2. ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼:"
	@echo "   - AWSèªè¨¼æƒ…å ±ã‚’ç¢ºèª: aws configure list --profile selfpomodoro-dev"
	@echo "   - serverless.yml ã®è¨­å®šã‚’ç¢ºèª"
	@echo ""
	@echo "3. ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:"
	@echo "   - .env ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®šã‚’ç¢ºèª"
	@echo "   - API Gateway ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLã‚’ç¢ºèª"
